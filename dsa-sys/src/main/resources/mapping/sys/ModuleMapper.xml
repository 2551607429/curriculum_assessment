<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dsa.sys.dao.ModuleDao">

    <!--   ====================================模块部分开始============================================   -->

    <!-- 获取树形module信息 -->
    <select id="findModuleTreeList"
            resultType="com.dsa.sys.dto.ModuleOutputDto">
        SELECT
        *
        FROM
        (
        SELECT
        a.ModuleID id,
        a.vc_Caption 'text',
        a.vc_Caption title,
        CONCAT('GP_', a.ModuleGroupID) pid,
        a.ModuleGroupID moduleGroupId,
        a.vc_ExecuteObject vcExecuteObject,
        a.vc_ExecuteParams vcExecuteParams,
        a.i_Sort iSort,
        a.vc_Image vcImage,
        a.i_FontSize iFontSize,
        a.i_IsEnable iIsEnable,
        a.i_Flag iFlag,
        a.vc_Memo vcMemo,
        m.vc_Name moduleGroupName,
        a.ModuleType moduleType,
        "1" isGroup
        FROM
        sys_Module a
        LEFT JOIN sys_DictData s ON s.DictID = a.ModuleType LEFT JOIN sys_ModuleGroup m ON a.ModuleGroupID
        = m.ModuleGroupID
        WHERE
        1=1
        UNION ALL
        SELECT
        CONCAT('GP_', c.ModuleGroupID) id,
        c.vc_Name 'text',
        c.vc_Name 'title',
        CONCAT('GP_', c.ParentID) pid,
        "" moduleGroupId,
        "" vcExecuteObject,
        "" vcExecuteParams,
        c.i_Sort iSort,
        "" vcImage,
        "" iFontSize,
        c.i_IsEnable iIsEnable,
        "" iFlag,
        c.vc_Memo vcMemo,
        "" moduleGroupName,
        "" moduleType,
        "0" isGroup
        FROM
        sys_ModuleGroup c
        WHERE
        1 = 1
        ) AS g
        WHERE
        1 = 1
        <if test="vcCaption != null and vcCaption != ''"><!-- 当用户选择模块名称查询时执行此操作 -->
            AND g.title like '%${vcCaption}%'
        </if>
        <if test="vcExecuteObject != null and vcExecuteObject != ''"><!-- 当用户选择执行对象查询时执行此操作 -->
            AND g.vcExecuteObject like '%${vcExecuteObject}%'
        </if>
        <if test="moduleType != null and moduleType != ''"><!-- 当用户选择模块类型查询时执行此操作 -->
            AND g.moduleType = #{moduleType}
        </if>
        <if test="moduleGroupId != null and moduleGroupId != ''">
            AND g.pid = "GP_${moduleGroupId}"
        </if>
        <if test="iIsEnable != null and (iIsEnable==0 ? '0' : iIsEnable)"><!-- 当用户选择是否启用时执行此操作 -->
            AND iIsEnable = #{iIsEnable}
        </if>
        ORDER BY g.iSort ,title ASC
    </select>

    <!-- 获取所有module信息 非树 -->
    <select id="findModule"
            resultType="com.dsa.sys.model.Module">
        SELECT
        ModuleID AS moduleId,
        vc_Caption AS vcCaption,
        ModuleType AS moduleType,
        vc_ExecuteObject AS vcExecuteObject,
        vc_ExecuteParams AS vcExecuteParams,
        ModuleGroupID AS moduleGroupId,
        i_Sort AS iSort,
        vc_Image AS vcImage,
        i_FontSize AS fontSize,
        i_IsEnable AS iIsEnable,
        i_Flag AS flag,
        vc_Memo AS vcMemo
        FROM
        sys_Module
        WHERE
        1 = 1
        <if test="moduleID != null and moduleID != ''"><!-- 模块ID -->
            AND ModuleID = #{moduleID}
        </if>
        <if test="vcExecuteObject != null and vcExecuteObject != ''"><!-- 模块名称 -->
            AND vc_ExecuteObject = #{vcExecuteObject}
        </if>
        <if test="moduleType != null and moduleType != ''"><!-- 模块类型 -->
            AND ModuleType = #{moduleType}
        </if>
        <if test="iIsEnable != null and (iIsEnable==0 ? '0' : iIsEnable)"><!-- 是否启用-->
            AND i_IsEnable = #{iIsEnable}
        </if>
    </select>

    <!-- 修改Module信息 -->
    <update id="updateModuleByModuleID">
        UPDATE sys_Module
        SET
        <trim suffixOverrides=",">
            <if test="vcCaption != null">
                vc_Caption = #{vcCaption},
            </if>
            <if test="moduleType != null">
                ModuleType = #{moduleType},
            </if>
            <if test="vcExecuteObject != null">
                vc_ExecuteObject = #{vcExecuteObject},
            </if>
            <if test="vcExecuteParams != null">
                vc_ExecuteParams = #{vcExecuteParams},
            </if>
            <if test="moduleGroupId != null">
                ModuleGroupID = #{moduleGroupId},
            </if>
            <if test="iSort != null">
                i_Sort = #{iSort},
            </if>
            <if test="vcImage != null">
                vc_Image = #{vcImage},
            </if>
            <if test="iFontSize != null">
                i_FontSize = #{iFontSize},
            </if>
            <if test="iFlag != null">
                i_Flag = #{iFlag},
            </if>
            <if test="vcMemo != null">
                vc_Memo = #{vcMemo},
            </if>

            <if test="iIsEnable != null and (iIsEnable==0 ? '0' : iIsEnable)">
                i_IsEnable = #{iIsEnable}
            </if>
        </trim>
        WHERE ModuleID = #{moduleId}
    </update>
    <!--根据ModuleID删除Module信息 -->
    <delete id="deleteModule">
        DELETE FROM sys_Module WHERE ModuleID = #{moduleId}
    </delete>

    <!-- 新增Module信息 -->
    <insert id="insertModuleInfo">
        insert into sys_Module
        (ModuleID,vc_Caption,ModuleType,vc_ExecuteObject,vc_ExecuteParams,ModuleGroupID,i_Sort,vc_Image,i_FontSize,i_IsEnable,i_Flag,vc_Memo)
        values
        (#{moduleId},#{vcCaption},#{moduleType},#{vcExecuteObject},#{vcExecuteParams},#{moduleGroupId},#{iSort},#{vcImage},#{iFontSize},#{iIsEnable},#{iFlag},#{vcMemo})
    </insert>

    <!-- 统计模块信息 用于分页总数据 数据唯一验证等 -->
    <select id="countModel" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM sys_Module WHERE 1 = 1
        <if test="moduleId != null and moduleId != ''">
            AND ModuleID = #{moduleId}
        </if>
        <if test="moduleGroupId != null and moduleGroupId != ''"><!-- 查询组下是否有模块信息 -->
            AND ModuleGroupID = #{moduleGroupId}
        </if>
    </select>

    <!-- 新增或修改时判断用户名是否重复 -->
    <select id="findVcNameCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM  sys_Module WHERE  vc_Caption = #{vcCaption}
        <if test="moduleId != null and moduleId != ''">
            AND ModuleID != #{moduleId}
        </if>
        <if test="moduleGroupId != null">
            AND ModuleGroupID = #{moduleGroupId}
        </if>
    </select>
    <select id="findMaxModuleId" resultType="java.lang.String"><!-- 获取最大的一条排序数据 -->
        SELECT MAX(ModuleID) FROM sys_Module
    </select>

    <!--   ====================================模块部分结束============================================   -->


    <!--  ====================================模块组部分开始============================================  -->

    <!-- 获取模块组信息 -->
    <select id="findModuleGroup" resultType="com.dsa.sys.dto.ModuleGroupOutputDto">
        SELECT
        ModuleGroupID moduleGroupId,
        ParentID parentId,
        vc_Name vcName,
        i_Sort sort,
        i_IsEnable iIsEnable,
        i_Flag flag,
        vc_Memo vcMemo
        FROM
        sys_ModuleGroup where 1 = 1
        <if test="moduleGroupId != null and moduleGroupId != ''"><!-- 模块组ID -->
            and ModuleGroupID = #{moduleGroupId}
        </if>
        ORDER BY i_Sort ,vc_Name ASC
    </select>

    <!--  -->
    <select id="findModuleGroupTreeParentId" resultType="com.dsa.sys.dto.ModuleOutputDto">
         SELECT
            CONCAT('GP_', c.ModuleGroupID) id,
            c.vc_Name 'text',
            c.vc_Name 'title',
            CONCAT('GP_',c.ParentID) pid,
            "" moduleType,
            "" vcExecuteObject,
            "" vcExecuteParams,
            "" iSort,
            "" vcImage,
            "" iFontSize,
            c.i_IsEnable iIsEnable,
            "" iFlag,
            "" vcMemo,
            "" vcName
        FROM
            sys_ModuleGroup c where 1 = 1
        and c.ModuleGroupID = #{parentId}
    </select>

    <!-- 树形ModuleGroup  -->
    <select id="findModuleGroupTree" resultType="com.dsa.utils.node.Node">
         SELECT
            c.ModuleGroupID id,
            c.vc_Name 'text',
            c.vc_Name 'title',
			c.ParentID pid,
			c.i_Sort iSort
        FROM
            sys_ModuleGroup c where 1 = 1
        ORDER BY c.i_Sort, c.vc_Name ASC
    </select>


    <!-- 新增ModuleGroup信息 -->
    <insert id="insertModuleGroupInfo">
        insert into sys_ModuleGroup
        (ModuleGroupID,ParentID,vc_Name,i_Sort,i_IsEnable,i_Flag,vc_Memo,i_Type)
        values
        (#{moduleGroupId},#{parentId},#{vcName},#{iSort},#{iIsEnable},#{iFlag},#{vcMemo},#{iType})
    </insert>
    <!-- 修改模块组信息 -->
    <update id="updateModuleGroup">
        UPDATE sys_ModuleGroup SET
        <trim suffixOverrides=",">
            <if test="parentId != null">
                ParentID = #{parentId},
            </if>
            <if test="vcName != null">
                vc_Name = #{vcName},
            </if>
            <if test="iSort != null">
                i_Sort = #{iSort},
            </if>
            <if test="iIsEnable != null and (iIsEnable==0 ? '0' : iIsEnable)">
                i_IsEnable = #{iIsEnable},
            </if>
            <if test="iFlag != null and (iFlag==0 ? '0' : iFlag)">
                i_Flag = #{iFlag},
            </if>
            <if test="vcMemo != null">
                vc_Memo = #{vcMemo},
            </if>
        </trim>
        WHERE ModuleGroupID = #{moduleGroupId}
    </update>
    <delete id="delModuleGroup">
        DELETE FROM sys_ModuleGroup WHERE ModuleGroupID = #{moduleGroupId}
    </delete>
    <!-- 统计组信息 用于分页总数据 数据唯一验证等 -->
    <select id="countModelGroup" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM sys_ModuleGroup WHERE 1 = 1
        <if test="vcName != null and vcName != ''">
            AND vc_Name = #{vcName}
        </if>
        <if test="moduleGroupId != null and moduleGroupId != ''">
            AND ModuleGroupID = #{moduleGroupId}
        </if>
    </select>
    <!-- 新增或修改时判断组名是否重复 -->
    <select id="findGroupVcNameCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM  sys_modulegroup WHERE  vc_Name = #{vcName}
        <if test="moduleGroupId != null and moduleGroupId != ''">
            AND ModuleGroupID != #{moduleGroupId}
        </if>
    </select>
    <select id="findMaxModuleGroupId" resultType="java.lang.String"><!-- 获取最大的一条排序数据 -->
        SELECT MAX(ModuleGroupID) FROM sys_ModuleGroup
    </select>
    <!-- ====================================模块组部分结束============================================ -->

</mapper>